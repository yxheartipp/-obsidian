---
alias: []
Type: 
tags: ["#review"]
sr-due: 2024-04-25
sr-interval: 1
sr-ease: 250
---

## 4线程 八百万数据量，后台4工作组，subcompaction1 

- sudo ./db_bench --benchmarks=fillseq --use_existing_db=0 --dev=/dev/nvme0n2 --num=8000000 --fs_uri=bluefs_rpc:///dev/nvme0n2//mount/host --compression_type=none --db=db --level0_file_num_compaction_trigger=4 --allow_concurrent_memtable_write=false --level0_slowdown_writes_trigger=20 --level0_stop_writes_trigger=30 --max_background_jobs=4 --max_write_buffer_number=2 --num_levels=6 --subcompactions=1 --statistics=0 --value_size=4096 --key_size=20 --stats_per_interval=1 --stats_interval_seconds=5 --report_interval_seconds=5 --report_file=./fillseq_8000000_threads_4:11:40.csv --threads=4
![[Pasted image 20240424115334.png]]
**![[Pasted image 20240424115424.png]]**
对于ssd的写入速度微微触发了毛刺和cpu基本处于平齐，cpu运算高时没有触发到毛刺。
在rocksdb的status信息中也可以看到没有触发stall，但是对应的qps有掉速。
![[Pasted image 20240424145448.png]]
## 8线程 八百万数据量，后台4工作组，subcompaction1 
- sudo ./db_bench --benchmarks=fillseq --use_existing_db=0 --dev=/dev/nvme0n2 --num=8000000 --fs_uri=bluefs_rpc:///dev/nvme0n2//mount/host --compression_type=none --db=db --level0_file_num_compaction_trigger=4 --allow_concurrent_memtable_write=false --level0_slowdown_writes_trigger=20 --level0_stop_writes_trigger=30 --max_background_jobs=8 --max_write_buffer_number=2 --num_levels=6 --subcompactions=1 --statistics=0 --value_size=4096 --key_size=20 --stats_per_interval=1 --stats_interval_seconds=5 --report_interval_seconds=5 --report_file=./fillseq_8000000_threads_8:11:40.csv --threads=8
![[Pasted image 20240424140225.png]]
Cpu出现了抖动但是仍然没有出现stall现象
![[Pasted image 20240424140407.png]]
![[Pasted image 20240424145353.png]]

## 16线程 八百万数据量，后台32工作组，subcompaction1 
sudo ./db_bench --benchmarks=fillseq --use_existing_db=0 --dev=/dev/nvme0n2 --num=8000000 --fs_uri=bluefs_rpc:///dev/nvme0n2//mount/host --compression_type=none --db=db --level0_file_num_compaction_trigger=4 --allow_concurrent_memtable_write=false --level0_slowdown_writes_trigger=10 --level0_stop_writes_trigger=20 --max_background_jobs=32 --max_write_buffer_number=2 --num_levels=6 --subcompactions=1 --statistics=0 --value_size=4096 --key_size=20 --stats_per_interval=1 --stats_interval_seconds=5 --report_interval_seconds=5 --report_file=./fillseq_8000000_threads_16:11:14:05.csv --threads=16
触发了Cumulative stall: 00:01:56.577 H:M:S, 8.9 percent
Interval stall: 00:00:0.511 H:M:S, 10.0 percent
使用了21分钟 cpu负载最多达到了93%
![[Pasted image 20240424143721.png]]
![[Pasted image 20240424143645.png]]![[Pasted image 20240424145202.png]]


## 总结
1. 随着线程的增加，多线程的反复写入会导致compaction的触发，但对于六核I5CPU来说，只会导致其触发write_slow，并不会轻易的触发write_stall。Ceph的配置同样使用6-10个核心允许 RocksDB 生成多达 32 个低优先级线程用于压缩和 8 个高优先级线程用于刷新，更加减少了write_stall的触发可能，但是我们的remote_compact并发处理没有保证，所以目前无法做这种测试。从数据中可以看出随着线程的增多总体的QPS处于上升阶段，但是还是出现了QPS的毛刺，也就是在Compaction的时候写入速度降低。**真正需要验证，海量数据的写入减负功能**需要保证盘上能够允许多线程的Compaction，同时盘上的计算效率需要大于等于或者略微小于主机侧。